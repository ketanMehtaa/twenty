---
title: ğŸ—ï¸ Complete Backend Guide  
info: Comprehensive guide to Twenty's backend architecture, modules, and development
icon: TbDatabase
image: /images/user-guide/fields/field.png
---

# ğŸ—ï¸ Complete Backend Guide

> **Your Complete Reference for Twenty's Backend System**
>
> This comprehensive guide covers everything about Twenty's backend - from high-level architecture and technology stack to detailed module documentation and development guidelines. It serves as your complete roadmap to understanding and building with the Twenty backend.

## ğŸ“‹ Table of Contents

- [ğŸŒŸ Architecture Overview](#-architecture-overview)
- [ğŸ› ï¸ Technology Stack](#ï¸-technology-stack)
- [ğŸ“ Project Structure](#-project-structure)
- [ğŸ›ï¸ Architecture Patterns](#ï¸-architecture-patterns)
- [âš™ï¸ Core Engine](#ï¸-core-engine)
- [ğŸ“Š Metadata System](#-metadata-system)
- [ğŸ¢ Workspace Architecture](#-workspace-architecture)
- [ğŸ”Œ GraphQL API Layer](#-graphql-api-layer)
- [ğŸ—„ï¸ Database Layer](#ï¸-database-layer)
- [âš¡ Background Jobs](#-background-jobs)
- [ğŸ§© Business Modules](#-business-modules)
- [ğŸ“– Development Guidelines](#-development-guidelines)

---

## ğŸŒŸ Architecture Overview

The Twenty backend (`twenty-server`) is a sophisticated NestJS application that provides a robust, scalable, and flexible API layer for the Twenty CRM platform. It implements a multi-tenant architecture with dynamic schema generation, comprehensive metadata management, and powerful workflow capabilities.

### ğŸ”‘ Key Characteristics

- **ğŸ¢ Multi-Tenant**: Complete workspace isolation with separate schemas
- **âš¡ Dynamic**: GraphQL schema generated from metadata
- **ğŸ›¡ï¸ Type-Safe**: Full TypeScript coverage
- **ğŸ“ˆ Scalable**: Horizontal scaling with Redis and PostgreSQL
- **ğŸ”§ Extensible**: Plugin architecture for custom functionality
- **ğŸ” Secure**: Role-based access control and field-level permissions

### ğŸ¯ Design Principles

- **ğŸ¯ Separation of Concerns**: Clear boundaries between features
- **ğŸ“ˆ Scalability**: Easy to add new features without affecting existing ones  
- **â™»ï¸ Reusability**: Shared components and utilities across modules
- **ğŸ”§ Maintainability**: Easier to understand, test, and modify code
- **ğŸ›¡ï¸ Type Safety**: Comprehensive TypeScript coverage

---

## ğŸ› ï¸ Technology Stack

### âš™ï¸ Core Technologies

```mermaid
graph LR
    NestJS["ğŸš€ NestJS 10.x<br/>Backend Framework"]
    TS["ğŸ“ TypeScript 5.x<br/>Type System"]
    ORM["ğŸ—„ï¸ TypeORM<br/>Database ORM"]
    GQL["ğŸ”Œ GraphQL Yoga<br/>GraphQL Server"]
    Valid["âœ… Class Validator<br/>Input Validation"]
    
    Postgres["ğŸ˜ PostgreSQL 14+<br/>Primary Database"]
    Redis["ğŸ”´ Redis<br/>Cache & Session Store"]
    Bull["âš¡ BullMQ<br/>Job Queue System"]
    
    NestJS --> TS
    NestJS --> ORM
    NestJS --> GQL
    NestJS --> Valid
    
    ORM --> Postgres
    NestJS --> Redis
    Redis --> Bull
```

### ğŸ“š Key Libraries

```
Authentication:
â”œâ”€â”€ Passport.js         # Auth middleware
â”œâ”€â”€ JWT                 # Token-based auth
â””â”€â”€ OAuth2              # Third-party auth

Data Processing:
â”œâ”€â”€ BullMQ              # Background jobs
â”œâ”€â”€ TypeORM             # ORM
â””â”€â”€ DataLoader          # Batch loading

Integration:
â”œâ”€â”€ Google APIs         # Gmail, Calendar
â”œâ”€â”€ Microsoft Graph     # Outlook
â””â”€â”€ Stripe              # Payments

Validation & Testing:
â”œâ”€â”€ Class Validator     # Input validation
â”œâ”€â”€ Jest                # Testing framework
â””â”€â”€ Supertest           # HTTP testing
```

---

## ğŸ“ Project Structure

### ğŸ—‚ï¸ Main Directory Structure

```
twenty-server/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ engine/                      # Core engine (main architecture)
â”‚   â”‚   â”œâ”€â”€ core-modules/           # Core functionality modules
â”‚   â”‚   â”‚   â”œâ”€â”€ auth/               # Authentication & authorization
â”‚   â”‚   â”‚   â”œâ”€â”€ user/               # User management
â”‚   â”‚   â”‚   â”œâ”€â”€ workspace/          # Workspace management
â”‚   â”‚   â”‚   â”œâ”€â”€ workspace-member/   # Member management
â”‚   â”‚   â”‚   â”œâ”€â”€ billing/            # Billing & subscriptions
â”‚   â”‚   â”‚   â”œâ”€â”€ feature-flag/       # Feature flags
â”‚   â”‚   â”‚   â”œâ”€â”€ file/               # File storage
â”‚   â”‚   â”‚   â”œâ”€â”€ analytics/          # Analytics tracking
â”‚   â”‚   â”‚   â”œâ”€â”€ api-key/            # API key management
â”‚   â”‚   â”‚   â””â”€â”€ webhook/            # Webhook management
â”‚   â”‚   â”œâ”€â”€ metadata-modules/       # Metadata system
â”‚   â”‚   â”‚   â”œâ”€â”€ object-metadata/    # Object definitions
â”‚   â”‚   â”‚   â”œâ”€â”€ field-metadata/     # Field definitions
â”‚   â”‚   â”‚   â”œâ”€â”€ relation-metadata/  # Relation definitions
â”‚   â”‚   â”‚   â”œâ”€â”€ data-source/        # Data source management
â”‚   â”‚   â”‚   â””â”€â”€ workspace-migration/ # Schema migrations
â”‚   â”‚   â”œâ”€â”€ workspace-manager/      # Workspace management
â”‚   â”‚   â”‚   â”œâ”€â”€ workspace-sync-metadata/ # Metadata sync
â”‚   â”‚   â”‚   â””â”€â”€ workspace-migration-runner/ # Migration execution
â”‚   â”‚   â”œâ”€â”€ api/                    # API layer
â”‚   â”‚   â”‚   â”œâ”€â”€ graphql/            # GraphQL API
â”‚   â”‚   â”‚   â””â”€â”€ rest/               # REST API
â”‚   â”‚   â”œâ”€â”€ workspace-datasource/   # Dynamic data sources
â”‚   â”‚   â””â”€â”€ workspace-resolver-builder/ # Dynamic resolvers
â”‚   â”œâ”€â”€ modules/                     # Business logic modules
â”‚   â”‚   â”œâ”€â”€ messaging/              # Email integration
â”‚   â”‚   â”‚   â”œâ”€â”€ message-import-manager/ # Email sync
â”‚   â”‚   â”‚   â”œâ”€â”€ message-participant/ # Email participants
â”‚   â”‚   â”‚   â””â”€â”€ message-thread/     # Email threading
â”‚   â”‚   â”œâ”€â”€ calendar/               # Calendar integration
â”‚   â”‚   â”‚   â”œâ”€â”€ calendar-event-import-manager/ # Event sync
â”‚   â”‚   â”‚   â””â”€â”€ calendar-event/     # Event management
â”‚   â”‚   â”œâ”€â”€ connected-account/      # Third-party accounts
â”‚   â”‚   â”œâ”€â”€ workflow/               # Workflow automation
â”‚   â”‚   â”‚   â”œâ”€â”€ workflow-runner/    # Workflow execution
â”‚   â”‚   â”‚   â”œâ”€â”€ workflow-trigger/   # Trigger system
â”‚   â”‚   â”‚   â””â”€â”€ workflow-action/    # Action system
â”‚   â”‚   â”œâ”€â”€ view/                   # View system
â”‚   â”‚   â”œâ”€â”€ favorite/               # Favorites
â”‚   â”‚   â””â”€â”€ favorite-folder/        # Favorite folders
â”‚   â”œâ”€â”€ database/                    # Database layer
â”‚   â”‚   â”œâ”€â”€ typeorm/                # TypeORM config
â”‚   â”‚   â”‚   â”œâ”€â”€ core/               # Core schema
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ migrations/     # Core migrations
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ core.datasource.ts # Core connection
â”‚   â”‚   â”‚   â””â”€â”€ metadata/           # Metadata schema
â”‚   â”‚   â”‚       â”œâ”€â”€ migrations/     # Metadata migrations
â”‚   â”‚   â”‚       â””â”€â”€ metadata.datasource.ts # Metadata connection
â”‚   â”‚   â””â”€â”€ typeorm-seeds/          # Database seeds
â”‚   â”œâ”€â”€ queue-worker/               # Background worker
â”‚   â”‚   â”œâ”€â”€ queues/                 # Queue definitions
â”‚   â”‚   â””â”€â”€ jobs/                   # Job handlers
â”‚   â”œâ”€â”€ command/                     # CLI commands
â”‚   â”‚   â”œâ”€â”€ database/               # Database commands
â”‚   â”‚   â””â”€â”€ workspace/              # Workspace commands
â”‚   â”œâ”€â”€ filters/                     # Exception filters
â”‚   â”œâ”€â”€ utils/                       # Utility functions
â”‚   â””â”€â”€ app.module.ts               # Root module
â”œâ”€â”€ test/                            # Integration tests
â”‚   â””â”€â”€ integration/                # Integration test suites
â””â”€â”€ package.json                     # Dependencies
```

### ğŸ§© Module Structure Example

```
src/modules/people/
â”œâ”€â”€ components/                      # Module-specific components
â”‚   â”œâ”€â”€ PeopleTable.tsx
â”‚   â”œâ”€â”€ PersonCard.tsx
â”‚   â””â”€â”€ PersonForm.tsx
â”œâ”€â”€ hooks/                          # Module-specific hooks
â”‚   â”œâ”€â”€ usePeople.ts
â”‚   â””â”€â”€ usePersonForm.ts
â”œâ”€â”€ graphql/                        # GraphQL queries/mutations
â”‚   â”œâ”€â”€ queries.ts
â”‚   â””â”€â”€ mutations.ts
â”œâ”€â”€ types/                          # Module-specific types
â”‚   â””â”€â”€ Person.ts
â”œâ”€â”€ utils/                          # Module utilities
â”‚   â””â”€â”€ personUtils.ts
â””â”€â”€ index.ts                        # Module exports
```

---

## ğŸ›ï¸ Architecture Patterns

### ğŸ“Š Layered Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ğŸ”Œ API Layer (GraphQL/REST)         â”‚
â”‚  â€¢ Request validation                       â”‚
â”‚  â€¢ Authentication/Authorization             â”‚
â”‚  â€¢ Response formatting                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           âš™ï¸ Service Layer                  â”‚
â”‚  â€¢ Business logic                           â”‚
â”‚  â€¢ Transaction management                   â”‚
â”‚  â€¢ Integration orchestration                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       ğŸ—„ï¸ Repository Layer (TypeORM)        â”‚
â”‚  â€¢ Data access                              â”‚
â”‚  â€¢ Query building                           â”‚
â”‚  â€¢ Cache management                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ğŸ˜ Database Layer (PostgreSQL)         â”‚
â”‚  â€¢ Data persistence                         â”‚
â”‚  â€¢ Transactions                             â”‚
â”‚  â€¢ Constraints                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ§© Module Architecture

```
NestJS Module Structure:

@Module({
  imports: [
    // Dependencies
    TypeOrmModule.forFeature([Entity]),
    OtherModule,
  ],
  controllers: [
    // REST controllers
    EntityController,
  ],
  providers: [
    // Services
    EntityService,
    // Resolvers (GraphQL)
    EntityResolver,
    // Repositories
    EntityRepository,
  ],
  exports: [
    // Exported services
    EntityService,
  ],
})
export class EntityModule {}
```

---

## âš™ï¸ Core Engine

The engine is the heart of Twenty's architecture, providing core functionality:

### ğŸ”§ Core Modules

#### 1. ğŸ” Auth Module (`engine/core-modules/auth`)

**Purpose**: Authentication and authorization

**Key Components:**
- `AuthService`: Main authentication logic
- `TokenService`: JWT token management
- `AuthResolver`: GraphQL auth endpoints
- `JwtAuthGuard`: Route protection

**Features:**
- Email/password authentication
- OAuth (Google, Microsoft)
- JWT token generation/validation
- Refresh token rotation
- API key authentication

**Flow:**
```
Login Request
    â”‚
    â–¼
AuthResolver.signIn()
    â”‚
    â–¼
AuthService.validateUser()
    â”‚
    â”œâ”€â–º Verify credentials
    â””â”€â–º Generate tokens
        â”‚
        â–¼
    Return { accessToken, refreshToken }
```

#### 2. ğŸ‘¤ User Module (`engine/core-modules/user`)

**Purpose**: User management

**Entities:**
```typescript
@Entity()
class User {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  email: string;

  @Column({ nullable: true })
  firstName: string;

  @Column({ nullable: true })
  lastName: string;

  @Column({ nullable: true })
  passwordHash: string;

  @ManyToOne(() => Workspace)
  defaultWorkspace: Workspace;

  @OneToMany(() => WorkspaceMember, member => member.user)
  workspaceMembers: WorkspaceMember[];
}
```

#### 3. ğŸ¢ Workspace Module (`engine/core-modules/workspace`)

**Purpose**: Multi-tenant workspace management

**Key Features:**
- Workspace creation
- Schema provisioning
- Workspace settings
- Member invitation
- Workspace deletion

**Workspace Creation Flow:**
```
1. Create workspace record (core schema)
2. Create PostgreSQL schema (workspace_xxx)
3. Run metadata migrations
4. Sync standard objects
5. Create default data (views, etc.)
6. Add creator as admin member
```

#### 4. ğŸ’° Billing Module (`engine/core-modules/billing`)

**Purpose**: Subscription and billing management

**Integration:** Stripe

**Features:**
- Subscription management
- Payment processing
- Plan upgrades/downgrades
- Usage tracking
- Billing portal

---

## ğŸ“Š Metadata System

The metadata system is what makes Twenty flexible and extensible.

### ğŸ¯ Metadata Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Metadata Schema (metadata)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Object Metadata                     â”‚  â”‚
â”‚  â”‚   - nameSingular: 'company'          â”‚  â”‚
â”‚  â”‚   - namePlural: 'companies'          â”‚  â”‚
â”‚  â”‚   - labelSingular: 'Company'         â”‚  â”‚
â”‚  â”‚   - isSystem: false                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                     â”‚                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Field Metadata                      â”‚  â”‚
â”‚  â”‚   - name: 'name'                     â”‚  â”‚
â”‚  â”‚   - type: 'TEXT'                     â”‚  â”‚
â”‚  â”‚   - label: 'Name'                    â”‚  â”‚
â”‚  â”‚   - isNullable: false                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                     â”‚                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Relation Metadata                   â”‚  â”‚
â”‚  â”‚   - relationType: 'ONE_TO_MANY'      â”‚  â”‚
â”‚  â”‚   - fromObjectId: xxx                â”‚  â”‚
â”‚  â”‚   - toObjectId: yyy                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Schema Generator                        â”‚
â”‚  - Generates GraphQL types                   â”‚
â”‚  - Generates database tables                 â”‚
â”‚  - Generates resolvers                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ“‹ Object Metadata

```typescript
@Entity()
class ObjectMetadata {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  nameSingular: string;

  @Column()
  namePlural: string;

  @Column()
  labelSingular: string;

  @Column()
  labelPlural: string;

  @Column()
  description: string;

  @Column({ nullable: true })
  icon: string;

  @Column({ default: false })
  isSystem: boolean;

  @Column({ default: true })
  isActive: boolean;

  @OneToMany(() => FieldMetadata, field => field.object)
  fields: FieldMetadata[];

  @ManyToOne(() => Workspace)
  workspace: Workspace;
}
```

### ğŸ·ï¸ Field Types

```typescript
enum FieldMetadataType {
  UUID = 'UUID',
  TEXT = 'TEXT',
  PHONE = 'PHONE',
  EMAIL = 'EMAIL',
  NUMERIC = 'NUMERIC',
  NUMBER = 'NUMBER',
  BOOLEAN = 'BOOLEAN',
  DATE_TIME = 'DATE_TIME',
  DATE = 'DATE',
  SELECT = 'SELECT',
  MULTI_SELECT = 'MULTI_SELECT',
  CURRENCY = 'CURRENCY',
  LINK = 'LINK',
  LINKS = 'LINKS',
  FULL_NAME = 'FULL_NAME',
  ADDRESS = 'ADDRESS',
  RATING = 'RATING',
  RELATION = 'RELATION',
  RICH_TEXT = 'RICH_TEXT',
}
```

### ğŸ”„ Metadata Sync Process

When objects/fields are created or modified:

```
1. Update metadata tables
    â”‚
    â–¼
2. Generate migration SQL
    â”‚
    â–¼
3. Execute migration
    â”‚
    â–¼
4. Regenerate GraphQL schema
    â”‚
    â–¼
5. Update resolvers
    â”‚
    â–¼
6. Clear cache
    â”‚
    â–¼
7. Notify clients (if needed)
```

---

## ğŸ¢ Workspace Architecture

### ğŸ”„ Multi-Schema Design

Each workspace has its own PostgreSQL schema:

```sql
-- Core schema (shared)
CREATE SCHEMA core;
CREATE TABLE core.users (...);
CREATE TABLE core.workspaces (...);

-- Metadata schema (shared)
CREATE SCHEMA metadata;
CREATE TABLE metadata.object_metadata (...);
CREATE TABLE metadata.field_metadata (...);

-- Workspace 1 schema
CREATE SCHEMA workspace_abc123;
CREATE TABLE workspace_abc123.companies (...);
CREATE TABLE workspace_abc123.people (...);

-- Workspace 2 schema
CREATE SCHEMA workspace_def456;
CREATE TABLE workspace_def456.companies (...);
CREATE TABLE workspace_def456.people (...);
```

### ğŸ­ Workspace Datasource

Dynamic datasource creation per workspace:

```typescript
@Injectable()
class WorkspaceDatasourceFactory {
  async createDatasource(workspaceId: string): Promise<DataSource> {
    const workspace = await this.findWorkspace(workspaceId);
    
    return new DataSource({
      type: 'postgres',
      host: process.env.DB_HOST,
      port: parseInt(process.env.DB_PORT),
      username: process.env.DB_USER,
      password: process.env.DB_PASSWORD,
      database: process.env.DB_NAME,
      schema: `workspace_${workspace.id}`,
      entities: await this.buildEntities(workspace),
    });
  }
}
```

---

## ğŸ”Œ GraphQL API Layer

### ğŸ¯ Dynamic Schema Generation

Schema is generated from metadata at runtime:

```typescript
class WorkspaceSchemaFactory {
  async createSchema(workspaceId: string): Promise<GraphQLSchema> {
    const objectMetadataCollection = await this.getObjectMetadata(workspaceId);
    
    // Generate types
    const types = objectMetadataCollection.map(object => 
      this.generateType(object)
    );
    
    // Generate queries
    const queries = objectMetadataCollection.map(object => ({
      [object.nameSingular]: this.generateFindOneQuery(object),
      [object.namePlural]: this.generateFindManyQuery(object),
    }));
    
    // Generate mutations
    const mutations = objectMetadataCollection.map(object => ({
      [`create${capitalize(object.nameSingular)}`]: this.generateCreateMutation(object),
      [`update${capitalize(object.nameSingular)}`]: this.generateUpdateMutation(object),
      [`delete${capitalize(object.nameSingular)}`]: this.generateDeleteMutation(object),
    }));
    
    return makeExecutableSchema({
      typeDefs: buildTypeDefs(types, queries, mutations),
      resolvers: buildResolvers(objectMetadataCollection),
    });
  }
}
```

### ğŸ“Š Generated Schema Example

```graphql
type Company {
  id: ID!
  name: String!
  domainName: String
  employees: Int
  address: Address
  createdAt: DateTime!
  updatedAt: DateTime!
  deletedAt: DateTime
  
  # Relations
  people: [Person!]!
  opportunities: [Opportunity!]!
}

type Query {
  company(id: ID!): Company
  companies(
    filter: CompanyFilterInput
    orderBy: [CompanyOrderByInput!]
    limit: Int
    offset: Int
  ): [Company!]!
}

type Mutation {
  createCompany(data: CompanyCreateInput!): Company!
  updateCompany(id: ID!, data: CompanyUpdateInput!): Company!
  deleteCompany(id: ID!): Company!
}
```

---

## ğŸ—„ï¸ Database Layer

### âš™ï¸ TypeORM Configuration

```typescript
// Core datasource
export const CoreDataSource = new DataSource({
  type: 'postgres',
  host: process.env.DB_HOST,
  port: parseInt(process.env.DB_PORT),
  username: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  database: process.env.DB_NAME,
  schema: 'core',
  entities: [User, Workspace, WorkspaceMember],
  migrations: ['src/database/typeorm/core/migrations/*.ts'],
});

// Metadata datasource
export const MetadataDataSource = new DataSource({
  type: 'postgres',
  host: process.env.DB_HOST,
  port: parseInt(process.env.DB_PORT),
  username: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  database: process.env.DB_NAME,
  schema: 'metadata',
  entities: [ObjectMetadata, FieldMetadata, RelationMetadata],
  migrations: ['src/database/typeorm/metadata/migrations/*.ts'],
});
```

### ğŸ”§ Repository Pattern

```typescript
@Injectable()
class CompanyService {
  constructor(
    @InjectRepository(Company, 'workspace')
    private companyRepository: Repository<Company>,
  ) {}

  async findAll(filter?: CompanyFilter): Promise<Company[]> {
    const queryBuilder = this.companyRepository.createQueryBuilder('company');
    
    if (filter?.name) {
      queryBuilder.andWhere('company.name ILIKE :name', {
        name: `%${filter.name}%`,
      });
    }
    
    return queryBuilder.getMany();
  }

  async create(data: CreateCompanyDto): Promise<Company> {
    const company = this.companyRepository.create(data);
    return this.companyRepository.save(company);
  }
}
```

---

## âš¡ Background Jobs

### ğŸ¯ BullMQ Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            API Server (Producer)             â”‚
â”‚  - Enqueue jobs                              â”‚
â”‚  - Monitor job status                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ Redis
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Redis (Queue)                   â”‚
â”‚  - Job persistence                           â”‚
â”‚  - Job scheduling                            â”‚
â”‚  - Job status                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Worker Process (Consumer)           â”‚
â”‚  - Process jobs                              â”‚
â”‚  - Handle retries                            â”‚
â”‚  - Report progress                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ­ Job Producer

```typescript
@Injectable()
class MessagingService {
  constructor(
    @InjectQueue('messaging')
    private messagingQueue: Queue,
  ) {}

  async syncMessages(connectedAccountId: string): Promise<void> {
    await this.messagingQueue.add('sync-messages', {
      connectedAccountId,
    }, {
      attempts: 3,
      backoff: {
        type: 'exponential',
        delay: 2000,
      },
    });
  }
}
```

### ğŸ”§ Job Consumer

```typescript
@Processor('messaging')
class MessagingProcessor {
  constructor(
    private messagingImportService: MessagingImportService,
  ) {}

  @Process('sync-messages')
  async handleSyncMessages(job: Job<{ connectedAccountId: string }>) {
    const { connectedAccountId } = job.data;
    
    // Update progress
    await job.progress(10);
    
    // Process messages
    const messages = await this.messagingImportService.fetchMessages(
      connectedAccountId
    );
    
    await job.progress(50);
    
    await this.messagingImportService.importMessages(messages);
    
    await job.progress(100);
    
    return { imported: messages.length };
  }

  @OnQueueError()
  onError(error: Error) {
    console.error('Queue error:', error);
  }

  @OnQueueFailed()
  onFailed(job: Job, error: Error) {
    console.error(`Job ${job.id} failed:`, error);
  }
}
```

---

## ğŸ§© Business Modules

### ğŸ¯ Module Architecture Overview

The Twenty backend follows a modular architecture where each module represents a distinct feature or domain. All modules are located in `packages/twenty-server/src/modules/` and are imported into the main `ModulesModule`.

```mermaid
flowchart TB
    subgraph Backend ["âš™ï¸ Twenty Backend Modules"]
        subgraph Core ["ğŸ”§ Core Modules"]
            Calendar["ğŸ“… Calendar"]
            Messaging["ğŸ“§ Messaging"]
            Workflow["âš¡ Workflow"]
            Timeline["ğŸ“ˆ Timeline"]
        end
        
        subgraph Data ["ğŸ“Š Data Modules"]
            Company["ğŸ¢ Company"]
            Person["ğŸ‘¤ Person"]
            Note["ğŸ“ Note"]
            Task["âœ… Task"]
            Opportunity["ğŸ’° Opportunity"]
        end
        
        subgraph Utils ["ğŸ› ï¸ Utility Modules"]
            Attachment["ğŸ“ Attachment"]
            Favorite["â­ Favorite"]
            View["ğŸ‘ï¸ View"]
            Dashboard["ğŸ“Š Dashboard"]
        end
    end
```

### ğŸ“ Directory Structure

```
ğŸ“ modules/
â”œâ”€â”€ ğŸ“„ attachment/              # File attachments
â”œâ”€â”€ ğŸš« blocklist/              # Contact/domain blocking
â”œâ”€â”€ ğŸ“… calendar/               # Calendar synchronization
â”œâ”€â”€ ğŸ¢ company/                # Company entities
â”œâ”€â”€ ğŸ”— connected-account/      # External account connections
â”œâ”€â”€ ğŸ¤– contact-creation-manager/ # Contact automation
â”œâ”€â”€ ğŸ“Š dashboard/              # Dashboard widgets
â”œâ”€â”€ â­ favorite/               # Favorites management
â”œâ”€â”€ ğŸ“ favorite-folder/        # Favorite folders
â”œâ”€â”€ ğŸ” match-participant/      # Participant matching
â”œâ”€â”€ ğŸ“§ messaging/              # Email/message sync
â”œâ”€â”€ ğŸ“ note/                   # Notes management
â”œâ”€â”€ ğŸ’° opportunity/            # Sales opportunities
â”œâ”€â”€ ğŸ‘¤ person/                 # Person/contact entities
â”œâ”€â”€ âœ… task/                   # Task management
â”œâ”€â”€ ğŸ“ˆ timeline/               # Activity timeline
â”œâ”€â”€ ğŸ‘ï¸ view/                   # Custom views & filters
â”œâ”€â”€ âš¡ workflow/               # Workflow automation
â””â”€â”€ ğŸ‘¥ workspace-member/       # Workspace members
```

## ğŸŒŸ Core Modules

### ğŸ“… Calendar Module

**Purpose**: Manages calendar events and synchronization with external calendar providers (Google Calendar, Microsoft Calendar, CalDAV).

**Location**: `src/modules/calendar/`

**Key Components**:
- `CalendarEventImportManagerModule` - Imports calendar events from external providers
- `CalendarEventCleanerModule` - Cleans up old or orphaned calendar events
- `CalendarEventParticipantManagerModule` - Manages event participants and attendees
- `CalendarBlocklistManagerModule` - Handles blocked calendar contacts
- `CalendarCommonModule` - Shared calendar utilities and services

**Submodules**:
- **Calendar Event Import Manager**: Handles importing events from various calendar providers
  - `drivers/google-calendar/` - Google Calendar API integration
  - `drivers/microsoft-calendar/` - Microsoft Calendar API integration
  - `drivers/caldav/` - CalDAV protocol support
  - Services: Event fetching, saving, and exception handling

**Use Cases**:
- Sync calendar events from external providers
- Display user calendar events in the CRM
- Manage meeting participants and attendees
- Handle calendar event notifications

---

### ğŸ“§ Messaging Module

**Purpose**: Manages email and message synchronization from external email providers (Gmail, Outlook, IMAP).

**Location**: `src/modules/messaging/`

**Key Components**:
- `MessagingImportManagerModule` - Core message import functionality
- `MessagingMessageCleanerModule` - Cleans up messages and maintains data hygiene
- `MessageParticipantManagerModule` - Manages email participants and threads
- `MessagingBlocklistManagerModule` - Handles blocked email addresses
- `MessagingMonitoringModule` - Monitors messaging system health and performance

**Submodules**:
- **Message Import Manager**: Comprehensive email import system
  - `drivers/gmail/` - Gmail API integration
  - `drivers/microsoft/` - Microsoft Graph API for Outlook
  - `drivers/imap/` - IMAP protocol support
  - Cron jobs for scheduled imports
  - Services for message parsing and storage

- **Message Folder Manager**: Manages email folder structure
  - Syncs folder hierarchies from external providers
  - Maps external folders to internal structure

**Use Cases**:
- Sync emails from connected accounts
- Display email threads in contact timelines
- Track email communications with leads/customers
- Monitor email engagement

---

### âš¡ Workflow Module

**Purpose**: Provides workflow automation capabilities, including triggers, actions, and execution engine.

**Location**: `src/modules/workflow/`

**Key Components**:
- `WorkflowBuilderModule` - Visual workflow builder and schema management
- `WorkflowExecutorModule` - Executes workflow actions
- `WorkflowRunnerModule` - Manages workflow runs and execution queue
- `WorkflowTriggerModule` - Handles workflow triggers (manual, automated)
- `WorkflowStatusModule` - Tracks workflow execution status
- `WorkflowToolsModule` - Provides workflow utility functions
- `WorkflowCommonModule` - Shared workflow utilities

**Submodules**:

**Workflow Builder**:
- `WorkflowVersionModule` - Manages workflow versions
- `WorkflowVersionStepModule` - Individual workflow steps
- `WorkflowVersionEdgeModule` - Connections between steps
- `WorkflowSchemaModule` - Workflow schema validation

**Workflow Executor**:
- **Actions**: Different types of workflow actions
  - `ai-agent/` - AI-powered actions
  - `code/` - Custom code execution
  - `filter/` - Conditional logic
  - `form/` - Form submissions
  - `iterator/` - Loop through items
  - `record-crud/` - Create, read, update, delete records
  - `empty/` - Placeholder actions

**Workflow Runner**:
- `WorkflowRunModule` - Individual workflow run management
- `WorkflowRunQueueModule` - Queue for workflow execution using BullMQ

**Workflow Trigger**:
- `AutomatedTriggerModule` - Database-based triggers
- Query hooks for triggering workflows on data changes

**Use Cases**:
- Automate repetitive tasks
- Create custom business logic flows
- Trigger actions based on data changes
- Build complex multi-step processes

---

### ğŸ”— Connected Account Module

**Purpose**: Manages external account connections (email, calendar) and OAuth authentication.

**Location**: `src/modules/connected-account/`

**Key Components**:
- `AccountsToReconnectService` - Identifies accounts needing re-authentication
- `ConnectedAccountListener` - Listens to account events
- `ConnectedAccountWorkspaceMemberListener` - Handles workspace member account changes
- `DeleteWorkspaceMemberConnectedAccountsCleanupJob` - Cleanup job for deleted accounts

**Submodules**:
- **OAuth2 Client Manager**: Manages OAuth2 authentication flows
  - Token acquisition and refresh
  - Provider-specific OAuth implementations

- **Refresh Tokens Manager**: Handles token refresh logic
  - Automatic token renewal
  - Token expiration management

- **Email Alias Manager**: Manages email aliases for sending
  - Configure send-as addresses
  - Verify email ownership

- **IMAP API**: Direct IMAP protocol support
  - Alternative to API-based email access
  - Self-hosted email server support

**Use Cases**:
- Connect Gmail/Outlook accounts
- Manage OAuth tokens and refresh
- Handle account disconnections
- Support multiple connected accounts per user

---

### ğŸ‘ï¸ View Module

**Purpose**: Manages custom views, filters, sorts, and field configurations for data tables.

**Location**: `src/modules/view/`

**Key Components**:
- View entities (ViewEntity, ViewFieldEntity, ViewFilterEntity, etc.)
- Integration with ObjectMetadataEntity for dynamic views
- Feature flag support for view capabilities

**Features**:
- **ViewEntity**: Stores view configurations
- **ViewFieldEntity**: Defines which fields are visible in a view
- **ViewFilterEntity**: Stores filter conditions
- **ViewFilterGroupEntity**: Groups multiple filters with AND/OR logic
- **ViewSortEntity**: Defines sort order
- **ViewGroupEntity**: Defines grouping logic

**Use Cases**:
- Create custom table views
- Save filter and sort configurations
- Share views across workspace members
- Personalize data display per user

---

### â­ Favorite Module

**Purpose**: Manages user favorites for quick access to records.

**Location**: `src/modules/favorite/`

**Key Components**:
- Standard objects for favorite records
- Services for managing favorites
- Listeners for favorite events
- Background jobs for cleanup

**Features**:
- Add/remove favorites
- Organize favorites in folders
- Quick access to frequently used records

**Use Cases**:
- Mark important contacts as favorites
- Quick access to active deals
- Organize frequently accessed records

---

## ğŸ“Š Data Management Modules

### ğŸ¢ Company Module

**Purpose**: Manages company/organization entities in the CRM.

**Location**: `src/modules/company/`

**Features**:
- Company standard object definitions
- Relationships with contacts and opportunities
- Company-specific fields and metadata

**Use Cases**:
- Store company information
- Link contacts to companies
- Track company-level activities

---

### ğŸ‘¤ Person Module

**Purpose**: Manages person/contact entities in the CRM.

**Location**: `src/modules/person/`

**Features**:
- Person standard object definitions
- Contact information management
- Relationships with companies and opportunities

**Use Cases**:
- Store contact information
- Track contact interactions
- Manage contact relationships

---

### ğŸ’° Opportunity Module

**Purpose**: Manages sales opportunities and pipeline stages.

**Location**: `src/modules/opportunity/`

**Features**:
- Opportunity standard object definitions
- Pipeline stage management
- Revenue and probability tracking

**Use Cases**:
- Track sales pipeline
- Forecast revenue
- Manage deal stages

---

### âœ… Task Module

**Purpose**: Manages tasks and to-do items.

**Location**: `src/modules/task/`

**Features**:
- Task standard object definitions
- Due dates and assignments
- Task status tracking

**Use Cases**:
- Create and assign tasks
- Track completion status
- Set reminders and due dates

---

### ğŸ“ Note Module

**Purpose**: Manages notes and text annotations.

**Location**: `src/modules/note/`

**Features**:
- Rich text note storage
- Association with any record type
- Note sharing and permissions

**Use Cases**:
- Add notes to contacts or deals
- Document meeting outcomes
- Share information with team

---

### ğŸ“„ Attachment Module

**Purpose**: Manages file attachments and uploads.

**Location**: `src/modules/attachment/`

**Features**:
- File upload handling
- Storage integration (local, S3, etc.)
- Association with any record type

**Use Cases**:
- Upload documents to records
- Store contracts and agreements
- Share files with team members

---

## ğŸ› ï¸ Supporting Modules

### ğŸ“ˆ Timeline Module

**Purpose**: Displays chronological activity timeline for records.

**Location**: `src/modules/timeline/`

**Features**:
- Aggregates activities across modules
- Displays emails, tasks, notes chronologically
- Filterable and searchable timeline

**Use Cases**:
- View all interactions with a contact
- Track deal progression history
- Audit record changes

---

### ğŸ“Š Dashboard Module

**Purpose**: Manages dashboard widgets and analytics.

**Location**: `src/modules/dashboard/`

**Features**:
- Widget management
- Dashboard layouts
- Data visualization

**Use Cases**:
- Display key metrics
- Create custom dashboards
- Track KPIs

---

### ğŸš« Blocklist Module

**Purpose**: Manages blocked contacts and domains for calendar and messaging.

**Location**: `src/modules/blocklist/`

**Features**:
- Block specific email addresses or domains
- Prevent sync from blocked sources
- Shared blocklist across workspace

**Use Cases**:
- Block spam contacts
- Exclude internal emails from sync
- Filter unwanted calendar invites

---

### ğŸ¤– Contact Creation Manager Module

**Purpose**: Automates contact creation from emails and calendar events.

**Location**: `src/modules/contact-creation-manager/`

**Features**:
- Automatic contact creation from email participants
- De-duplication logic
- Smart contact matching

**Use Cases**:
- Auto-create contacts from email threads
- Populate CRM from calendar meetings
- Reduce manual data entry

---

### ğŸ” Match Participant Module

**Purpose**: Matches email/calendar participants with existing contacts.

**Location**: `src/modules/match-participant/`

**Features**:
- Email-based matching
- Fuzzy name matching
- Conflict resolution

**Use Cases**:
- Link email participants to CRM contacts
- Match calendar attendees to people records
- Resolve duplicate contacts

---

### ğŸ‘¥ Workspace Member Module

**Purpose**: Manages workspace members and their permissions.

**Location**: `src/modules/workspace-member/`

**Features**:
- Member management
- Role and permission assignments
- Member activity tracking

**Use Cases**:
- Add team members to workspace
- Assign roles and permissions
- Track member activity

---

## ğŸ”„ Module Relationships

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ModulesModule                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                â”‚                â”‚
          â–¼                â–¼                â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   Calendar   â”‚  â”‚  Messaging   â”‚  â”‚  Workflow    â”‚
  â”‚   Module     â”‚  â”‚   Module     â”‚  â”‚   Module     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                â”‚                â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  ConnectedAccount    â”‚
                â”‚      Module          â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                â”‚                â”‚
          â–¼                â–¼                â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   Person     â”‚  â”‚   Company    â”‚  â”‚ Opportunity  â”‚
  â”‚   Module     â”‚  â”‚   Module     â”‚  â”‚   Module     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“– Development Guidelines

### ğŸ—ï¸ Module Structure

Most modules follow this standard structure:

```
module-name/
â”œâ”€â”€ module-name.module.ts     # Main module definition
â”œâ”€â”€ services/                 # Business logic services
â”œâ”€â”€ listeners/                # Event listeners
â”œâ”€â”€ jobs/                     # Background jobs (cron)
â”œâ”€â”€ query-hooks/              # Database query hooks
â”œâ”€â”€ standard-objects/         # Standard object definitions
â”œâ”€â”€ types/                    # TypeScript types
â”œâ”€â”€ utils/                    # Utility functions
â””â”€â”€ constants/                # Module constants
```

### ğŸ”§ Service Layer

Services contain the core business logic and are exported for use by other modules. Example:

```typescript
@Injectable()
export class MyService {
  constructor(
    private readonly workspaceDataSourceService: WorkspaceDataSourceService,
  ) {}

  async doSomething(): Promise<Result> {
    // Business logic here
  }
}
```

### ğŸ§ Listeners

Listeners respond to events from other parts of the system:

```typescript
@Injectable()
export class MyListener {
  @OnEvent('entity.created')
  async handleEntityCreated(payload: EntityCreatedEvent) {
    // Handle event
  }
}
```

### âš¡ Background Jobs

Background jobs run on schedules or in response to queue events:

```typescript
@Processor(MessageQueue.cronQueue)
export class MyJob {
  @Process(MyJobPattern)
  async process(job: Job<MyJobData>) {
    // Job execution logic
  }
}
```

### ğŸ“Š DTO Validation

```typescript
// dto/create-entity.dto.ts
export class CreateEntityDto {
  @IsString()
  @IsNotEmpty()
  name: string;

  @IsEmail()
  @IsOptional()
  email?: string;

  @IsNumber()
  @Min(0)
  @Max(1000)
  @IsOptional()
  employees?: number;
}
```

### ğŸš¨ Error Handling

```typescript
// Custom exception
export class EntityNotFoundException extends NotFoundException {
  constructor(id: string) {
    super(`Entity with ID ${id} not found`);
  }
}

// Usage
async findById(id: string): Promise<Entity> {
  const entity = await this.entityRepository.findOne({ where: { id } });
  
  if (!entity) {
    throw new EntityNotFoundException(id);
  }
  
  return entity;
}
```

### ğŸ§ª Testing

```typescript
// entity.service.spec.ts
describe('EntityService', () => {
  let service: EntityService;
  let repository: Repository<Entity>;

  beforeEach(async () => {
    const module = await Test.createTestingModule({
      providers: [
        EntityService,
        {
          provide: getRepositoryToken(Entity),
          useValue: {
            find: jest.fn(),
            findOne: jest.fn(),
            save: jest.fn(),
          },
        },
      ],
    }).compile();

    service = module.get<EntityService>(EntityService);
    repository = module.get<Repository<Entity>>(getRepositoryToken(Entity));
  });

  it('should find all entities', async () => {
    const entities = [{ id: '1', name: 'Test' }];
    jest.spyOn(repository, 'find').mockResolvedValue(entities);

    expect(await service.findAll()).toEqual(entities);
  });
});
```

### ğŸ¯ Best Practices

1. **Follow the modular approach**: Each module should have a single, well-defined responsibility
2. **Export services**: Make services available to other modules through the `exports` array
3. **Use dependency injection**: Leverage NestJS DI for loose coupling
4. **Implement listeners**: Use event-driven architecture for cross-module communication
5. **Define standard objects**: Use the standard object system for consistent data models
6. **Add query hooks**: Implement authorization and validation at the data layer
7. **Create background jobs**: Use jobs for long-running or scheduled operations
8. **Write tests**: Include unit and integration tests for all services
9. **Document types**: Use TypeScript interfaces and types for type safety
10. **Handle errors**: Implement proper error handling and logging

### ğŸ§ª Testing Modules

Each module should include:
- **Unit tests** for services and utilities
- **Integration tests** for complex workflows
- **E2E tests** for API endpoints

Run tests:
```bash
npx nx test twenty-server                          # Unit tests
npx nx run twenty-server:test:integration:with-db-reset  # Integration tests
```

### â• Adding a New Module

To add a new module:

1. Create module directory: `src/modules/my-module/`
2. Create module file: `my-module.module.ts`
3. Add services, listeners, jobs as needed
4. Export module in `modules.module.ts`
5. Define standard objects if needed
6. Add tests
7. Document the module

Example module:

```typescript
import { Module } from '@nestjs/common';

@Module({
  imports: [],
  providers: [MyService],
  exports: [MyService],
})
export class MyModule {}
```

---

## ğŸ”— Related Documentation

- [ğŸ“Š GraphQL Complete Guide](./graphql-complete-guide.mdx) - Complete GraphQL API reference
- [ğŸ—ï¸ Complete Architecture Guide](./complete-architecture-guide.mdx) - Frontend architecture overview
- [ğŸ³ Docker Architecture](./twenty-docker-architecture.mdx) - Deployment and containerization

### ğŸ“š External Resources

- [NestJS Documentation](https://docs.nestjs.com)
- [TypeORM Documentation](https://typeorm.io)
- [GraphQL Yoga Documentation](https://the-guild.dev/graphql/yoga-server)
- [BullMQ Documentation](https://docs.bullmq.io)
- [PostgreSQL Documentation](https://www.postgresql.org/docs)

---

*This comprehensive backend guide is maintained to provide developers with a complete understanding of Twenty's backend system, modules, and development patterns. It serves as the definitive reference for backend development on the Twenty platform.*